<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>iMail Masivo - Enterprise</title>
    <link href="https://fonts.cdnfonts.com/css/lucida-grande" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="imac-shell">
        
        <div class="monitor-bezel">
            <div class="screen-glass">
                
                <div class="macos-window">
                    
                    <div class="window-header">
                        <span class="close-btn"></span>
                        <div class="title-container">
                            <span class="window-title">iMail Sender</span>
                            <span class="separator">|</span>
                            <span id="connected-user" class="user-display">--</span>
                        </div>
                        <div class="quota-badge">
                            L√≠mite Diario: <span id="quota-count">--</span>
                        </div>
                    </div>

                    <div class="tab-bar">
                        <button class="tab-btn active" onclick="switchTab('main')">üìß Redactar Correo</button>
                        <button class="tab-btn" onclick="switchTab('config')">‚öôÔ∏è Configuraci√≥n</button>
                    </div>

                    <div class="window-content">
                        
                        <div id="tab-main" class="tab-pane active">
                            
                            <div class="control-group">
                                <label class="mac-label">Remitente (De:):</label>
                                <select id="fromEmail" class="mac-input">
                                    <option value="">(Conecta para cargar cuentas...)</option>
                                </select>
                                <div style="font-size:11px; color:#666; margin-top:3px;">* Muestra tu cuenta principal y alias verificados.</div>
                            </div>

                            <div class="control-group">
                                <label class="mac-label">1. Destinatarios (.csv / .txt):</label>
                                <div class="custom-file-row">
                                    <label for="csvFile" class="mac-btn-glossy">Seleccionar Lista...</label>
                                    <input type="file" id="csvFile" accept=".csv, .txt" style="display:none;">
                                    <div id="led-list" class="status-led" title="Estado"></div>
                                    <span id="file-name-display" class="file-name-display">Ninguno</span>
                                    <button class="info-btn" onclick="toggleInfoModal()">?</button>
                                </div>
                            </div>

                            <div class="control-group">
                                <label class="mac-label">2. Asunto:</label>
                                <input type="text" id="subject" class="mac-input" placeholder="Asunto del correo...">
                            </div>

                            <div class="control-group">
                                <label class="mac-label">3. Mensaje:</label>
                                <textarea id="body" class="mac-textarea" placeholder="Escribe el cuerpo del mensaje..."></textarea>
                            </div>

                            <div class="control-group">
                                <label class="mac-label">3.1 Bot√≥n WhatsApp (Opcional):</label>
                                <input type="text" id="whatsappNumber" class="mac-input" placeholder="Ej: 56912345678 (Solo n√∫meros, con c√≥digo de pa√≠s)" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                            </div>

                            <fieldset class="mac-fieldset">
                                <legend>4. Firma / Pie de P√°gina</legend>
                                <div class="radio-group-container">
                                    <label><input type="radio" name="footerType" value="text" checked onchange="toggleFooterMode()"> Texto</label>
                                    <label><input type="radio" name="footerType" value="image" onchange="toggleFooterMode()"> Imagen (Banner)</label>
                                </div>
                                
                                <div id="footer-text-box">
                                    <textarea id="footerText" class="mac-textarea small" placeholder="Atte. Tu Nombre..."></textarea>
                                </div>
                                
                                <div id="footer-image-box" style="display:none;">
                                    <div class="custom-file-row">
                                        <label for="footerImageInput" class="mac-btn-small">Buscar Imagen...</label>
                                        <input type="file" id="footerImageInput" accept="image/*" style="display:none">
                                        <div id="led-footer" class="status-led"></div>
                                        <span id="footer-img-status" class="file-name-display" style="display:none"></span>
                                    </div>
                                </div>
                            </fieldset>

                            <div class="control-group" style="border-top:1px dotted #ccc; padding-top:10px;">
                                <label class="mac-label">5. Adjuntar Archivos (Opcional):</label>
                                <div class="custom-file-row">
                                    <label for="attachment" class="mac-btn-small">Examinar...</label>
                                    <input type="file" id="attachment" multiple style="display:none">
                                    <div id="led-attach" class="status-led"></div>
                                    <span id="attach-status" class="file-name-display" style="display:none"></span>
                                </div>
                                <div id="file-list-container" class="file-grid"></div>
                            </div>

                            <div class="action-bar">
                                <button class="mac-btn-primary" onclick="startSending()">Enviar Correos</button>
                            </div>
                        </div>

                        <div id="tab-config" class="tab-pane">
                            <h3 class="config-title">Configuraci√≥n del Servidor</h3>
                            
                            <div id="step-1" class="step-box wizard-step">
                                <p style="margin-bottom:5px;"><b>Paso 1:</b> Crea el Script.</p>
                                <div style="font-size:11px; margin-left:10px;">
                                    1. Ve a <a href="https://script.google.com/home" target="_blank" style="color:#00457a; font-weight:bold; text-decoration:none;">script.google.com</a>.<br>
                                    2. Clic en <b>"Nuevo proyecto"</b>.
                                </div>
                                <img src="paso 1.png" class="wizard-img" onclick="expandImage(this.src)">
                                <div class="wizard-nav right">
                                    <button class="mac-btn-small" onclick="nextStep(2)">Siguiente &rarr;</button>
                                </div>
                            </div>

                            <div id="step-2" class="step-box wizard-step" style="display:none;">
                                <p style="margin-bottom:5px;"><b>Paso 2:</b> Copia y pega el c√≥digo.</p>
                                <div style="font-size:11px; margin-left:10px; margin-bottom:5px;">
                                    Borra el c√≥digo por defecto y pega este:
                                </div>
                                <textarea class="code-box" readonly>
function doPost(e) {
  var output = ContentService.createTextOutput();
  output.setMimeType(ContentService.MimeType.JSON);
  try {
    var data = JSON.parse(e.postData.contents);
    var currentUser = Session.getEffectiveUser().getEmail();
    
    // Acci√≥n: Check Quota y Obtener Alias
    if (data.action === "check_quota") {
      var remaining = MailApp.getRemainingDailyQuota();
      // Obtener alias configurados en Gmail
      var aliases = GmailApp.getAliases();
      // Agregar el correo principal al inicio de la lista
      aliases.unshift(currentUser);
      
      output.setContent(JSON.stringify({ 
        status: "success", 
        quota: remaining, 
        user: currentUser,
        aliases: aliases // Devolvemos la lista al frontend
      }));
      return output;
    }
    
    var options = { htmlBody: data.html };
    
    // Configuraci√≥n de Alias (Remitente)
    if (data.fromAlias && data.fromAlias !== "") {
      options.from = data.fromAlias;
    }

    if (data.attachments && data.attachments.length > 0) {
      var blobs = [];
      for(var i=0; i<data.attachments.length; i++){
        var att = data.attachments[i];
        var decoded = Utilities.base64Decode(att.data);
        blobs.push(Utilities.newBlob(decoded, att.mime, att.name));
      }
      options.attachments = blobs;
    }
    
    GmailApp.sendEmail(data.to, data.subject, "Ver HTML", options);
    var finalQuota = MailApp.getRemainingDailyQuota();
    output.setContent(JSON.stringify({ status: "success", quota: finalQuota, user: currentUser }));
    return output;
  } catch (error) {
    output.setContent(JSON.stringify({ status: "error", message: error.toString() }));
    return output;
  }
}</textarea>
                                <div style="margin-top:5px;">
                                    <button class="mac-btn-small" onclick="copyCode()">Copiar C√≥digo</button>
                                </div>
                                <img src="paso 2.png" class="wizard-img" style="max-height:none; width:100%;" onclick="expandImage(this.src)">
                                <div class="wizard-nav">
                                    <button class="mac-btn-small" onclick="nextStep(1)">&larr; Atr√°s</button>
                                    <button class="mac-btn-small" onclick="nextStep(3)">Siguiente &rarr;</button>
                                </div>
                            </div>

                            <div id="step-3" class="step-box wizard-step" style="display:none;">
                                <p style="margin-bottom:5px;"><b>Paso 3a:</b> Implementar.</p>
                                <ul style="font-size:11px; margin:0; padding-left:20px; color:#333;">
                                    <li>Bot√≥n azul <b>Implementar</b> &rarr; <b>Nueva implementaci√≥n</b>.</li>
                                </ul>
                                <img src="paso 3.1.png" class="wizard-img" onclick="expandImage(this.src)">
                                <div class="wizard-nav">
                                    <button class="mac-btn-small" onclick="nextStep(2)">&larr; Atr√°s</button>
                                    <button class="mac-btn-small" onclick="nextStep(4)">Siguiente &rarr;</button>
                                </div>
                            </div>

                            <div id="step-4" class="step-box wizard-step" style="display:none;">
                                <p style="margin-bottom:5px;"><b>Paso 3b:</b> Tipo de App.</p>
                                <ul style="font-size:11px; margin:0; padding-left:20px; color:#333;">
                                    <li>Clic en la tuerca (<span style="font-size:12px;">‚öôÔ∏è</span>) &rarr; Selecciona <b>Aplicaci√≥n web</b>.</li>
                                </ul>
                                <img src="paso 3.2.png" class="wizard-img" onclick="expandImage(this.src)">
                                <div class="wizard-nav">
                                    <button class="mac-btn-small" onclick="nextStep(3)">&larr; Atr√°s</button>
                                    <button class="mac-btn-small" onclick="nextStep(5)">Siguiente &rarr;</button>
                                </div>
                            </div>

                            <div id="step-5" class="step-box wizard-step" style="display:none;">
                                <p style="margin-bottom:5px;"><b>Paso 3c:</b> Configuraci√≥n de acceso.</p>
                                <ul style="font-size:11px; margin:0; padding-left:20px; color:#333;">
                                    <li><b>Descripci√≥n:</b> iMail.</li>
                                    <li><b>Ejecutar como:</b> Yo.</li>
                                    <li><b>Qui√©n tiene acceso:</b> <span style="background:#ffffcc; padding:0 3px; border:1px solid #eec;">Cualquiera</span>.</li>
                                    <li>Clic en <b>Implementar</b>.</li>
                                </ul>
                                <img src="paso 3.3.jpg" class="wizard-img" onclick="expandImage(this.src)">
                                <div class="wizard-nav">
                                    <button class="mac-btn-small" onclick="nextStep(4)">&larr; Atr√°s</button>
                                    <button class="mac-btn-small" onclick="nextStep(6)">Siguiente &rarr;</button>
                                </div>
                            </div>

                            <div id="step-6" class="step-box wizard-step" style="display:none;">
                                <p style="margin-bottom:5px;"><b>Paso 4a:</b> Autorizaci√≥n.</p>
                                <div style="font-size:11px; margin-left:10px;">
                                    Google pedir√° permisos. Haz clic en <b>Autorizar acceso</b>.
                                </div>
                                <img src="paso 4.png" class="wizard-img" onclick="expandImage(this.src)">
                                <div class="wizard-nav">
                                    <button class="mac-btn-small" onclick="nextStep(5)">&larr; Atr√°s</button>
                                    <button class="mac-btn-small" onclick="nextStep(7)">Siguiente &rarr;</button>
                                </div>
                            </div>

                            <div id="step-7" class="step-box wizard-step" style="display:none;">
                                <p style="margin-bottom:5px;"><b>Paso 4b:</b> Login.</p>
                                <div style="font-size:11px; margin-left:10px;">
                                    Selecciona tu cuenta de Google.
                                </div>
                                <img src="paso 4.1.png" class="wizard-img" onclick="expandImage(this.src)">
                                <div class="wizard-nav">
                                    <button class="mac-btn-small" onclick="nextStep(6)">&larr; Atr√°s</button>
                                    <button class="mac-btn-small" onclick="nextStep(8)">Siguiente &rarr;</button>
                                </div>
                            </div>

                            <div id="step-8" class="step-box wizard-step" style="display:none;">
                                <p style="margin-bottom:5px;"><b>Paso 4c:</b> Permitir.</p>
                                <div style="font-size:11px; margin-left:10px;">
                                    Clic en <b>Allow</b> (Permitir) o Continue.
                                </div>
                                <img src="paso 4.2.png" class="wizard-img" onclick="expandImage(this.src)">
                                <div class="wizard-nav">
                                    <button class="mac-btn-small" onclick="nextStep(7)">&larr; Atr√°s</button>
                                    <button class="mac-btn-small" onclick="nextStep(9)">Siguiente &rarr;</button>
                                </div>
                            </div>

                            <div id="step-9" class="step-box wizard-step" style="display:none;">
                                <p style="margin-bottom:5px;"><b>Paso 4 (Final):</b> Copiar URL.</p>
                                <div style="font-size:11px; margin-left:10px;">
                                    Copia la URL de la aplicaci√≥n web generada.
                                </div>
                                <img src="paso 4.3.png" class="wizard-img" onclick="expandImage(this.src)">
                                <div class="wizard-nav">
                                    <button class="mac-btn-small" onclick="nextStep(8)">&larr; Atr√°s</button>
                                    <button class="mac-btn-small" onclick="nextStep(10)">Finalizar &rarr;</button>
                                </div>
                            </div>

                            <div id="step-10" class="step-box wizard-step" style="background:#e8f4fa; border-color:#a6cbd9; display:none;">
                                <p style="margin-bottom:5px; color:#00457a;"><b>Paso 5:</b> Conectar.</p>
                                <div style="font-size:11px; margin-left:10px; margin-bottom:5px;">
                                    Pega la URL de la aplicaci√≥n web aqu√≠:
                                </div>
                                <div style="display:flex; gap:5px;">
                                    <input type="text" id="configUrlInput" class="mac-input" placeholder="https://script.google.com/macros/s/..." style="flex:1;">
                                </div>
                                <div style="text-align:right; margin-top:5px;">
                                    <button class="mac-btn-primary" style="width:auto; padding: 4px 15px; font-size:11px;" onclick="saveConfig()">Guardar y Conectar</button>
                                </div>
                                <div class="wizard-nav">
                                    <button class="mac-btn-small" onclick="nextStep(9)">&larr; Atr√°s</button>
                                </div>
                            </div>

                        </div>

                    </div>
                    
                    <div class="window-footer-status" id="status-bar">
                        Sistema listo.
                    </div>
                </div>

                <div id="imgZoomModal" class="modal-overlay-local" style="display:none;" onclick="closeImgModal()">
                    <div class="mac-popup-window" onclick="event.stopPropagation()">
                        <div class="mac-popup-header">
                            <div class="mac-traffic-lights">
                                <span class="mac-dot red" onclick="closeImgModal()" title="Cerrar"></span>
                                <span class="mac-dot yellow"></span>
                                <span class="mac-dot green"></span>
                            </div>
                            <span class="mac-popup-title">Vista Previa</span>
                        </div>
                        <div class="mac-popup-body">
                            <img id="imgZoomTarget" src="">
                        </div>
                    </div>
                </div>

            </div>
        </div>
        
        <div class="custom-logo-area">
            <img src="logo.png" alt="Effectiva Logo" class="effectiva-logo-img">
        </div>
    </div>

    <div id="macLoader" class="modal-overlay" style="display:none;">
        <div class="mini-window">
            <div class="window-header"><span class="window-title">Procesando...</span></div>
            <div class="modal-content">
                <p id="loader-text" style="font-size:11px; margin-bottom:5px;">Conectando...</p>
                <div class="mac-progress-track"><div class="mac-progress-bar" id="progress-fill"></div></div>
            </div>
        </div>
    </div>

    <div id="infoModal" class="modal-overlay" style="display:none;">
        <div class="mini-window">
            <div class="window-header">
                <span class="close-btn" onclick="toggleInfoModal()"></span>
                <span class="window-title">Ayuda</span>
            </div>
            <div class="modal-content">
                <p style="font-weight:bold; font-size:11px;">Formato de Lista</p>
                <div class="code-example">
                    cliente1@empresa.com<br>
                    ventas@negocio.cl
                </div>
                <button class="mac-btn-small" style="margin-top:10px;" onclick="toggleInfoModal()">Entendido</button>
            </div>
        </div>
    </div>

    <div id="messageModal" class="modal-overlay" style="display:none; z-index:200;">
        <div class="mini-window" style="width: 300px;">
            <div class="window-header">
                <span class="close-btn" onclick="closeMessage()"></span>
                <span class="window-title" id="msg-title">Aviso del Sistema</span>
            </div>
            <div class="modal-content">
                <div style="font-size:30px; margin-bottom:10px;">‚ú®</div>
                <p id="msg-text" style="font-size:12px; margin-bottom:15px; color:#333; line-height:1.4;">Mensaje...</p>
                <button class="mac-btn-small" style="width:80px; font-weight:bold;" onclick="closeMessage()">OK</button>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
</body>
</html>